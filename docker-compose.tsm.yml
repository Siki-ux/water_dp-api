version: '3.8'

services:
  # Disable local postgres for this profile
  postgres-app:
    profiles: [donotstart]

  api:
    environment:
      # Connect to TSM database
      - DATABASE_URL=postgresql://${DATABASE_USER:-postgres}:${DATABASE_PASSWORD:-postgres}@database:5432/${POSTGRES_DB:-postgres}?options=-csearch_path=water_dp,public
      - TIMEIO_DB_HOST=database
      - TIMEIO_DB_NAME=${POSTGRES_DB:-postgres}
      # FROST internal URL
      - FROST_URL=http://frost:8080
      - MQTT_BROKER_HOST=mqtt-broker
      # MinIO (TSM object-storage service)
      - MINIO_URL=object-storage:9000
      - MINIO_ACCESS_KEY=${OBJECT_STORAGE_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${OBJECT_STORAGE_ROOT_PASSWORD:-minioadmin}
      - MINIO_SECURE=false
    depends_on:
      postgres-app:
        condition: service_started
        required: false
    networks:
      - tsm_network

  worker:
    environment:
      - DATABASE_URL=postgresql://${DATABASE_USER:-postgres}:${DATABASE_PASSWORD:-postgres}@database:5432/${POSTGRES_DB:-postgres}?options=-csearch_path=water_dp,public
      - TIMEIO_DB_HOST=database
      - TIMEIO_DB_NAME=${POSTGRES_DB:-postgres}
      - FROST_URL=http://frost:8080
      - MQTT_BROKER_HOST=mqtt-broker
    depends_on:
      postgres-app:
        condition: service_started
        required: false
    networks:
      - tsm_network

  geoserver-init:
    environment:
      - DB_HOST=database
      - DB_NAME=${POSTGRES_DB:-postgres}
      - DB_USER=${DATABASE_USER:-postgres}
      - DB_PASSWORD=${DATABASE_PASSWORD:-postgres}
    depends_on:
      postgres-app:
        condition: service_started
        required: false
    networks:
      - tsm_network

  water-dp-geoserver:
    networks:
      - tsm_network

  frontend:
    networks:
      - tsm_network

  redis:
    networks:
      - tsm_network
